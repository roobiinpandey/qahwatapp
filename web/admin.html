<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qahwat Al Emarat - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513, #D2691E);
            min-height: 100vh;
        }

        .admin-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            font-size: 1.8rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #admin-status {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #219a52;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .admin-nav {
            background: white;
            padding: 0 2rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 1rem;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: #f8f9fa;
        }

        .nav-btn.active {
            border-bottom-color: #3498db;
            background: #f8f9fa;
        }

        .admin-main {
            flex: 1;
            padding: 2rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .content-section h2 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .section-actions {
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .data-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            font-weight: 600;
            color: #2c3e50;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 2rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group input[type="file"] {
            padding: 0.5rem;
            border: 2px dashed #ddd;
            background: #f8f9fa;
            cursor: pointer;
        }

        .form-group input[type="file"]:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .form-hint {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Login Form Styles */
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 3rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .admin-nav {
                flex-wrap: wrap;
                padding: 0 1rem;
            }

            .nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .admin-main {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            .modal-content {
                margin: 2% auto;
                padding: 1rem;
            }
        }
        /* Enhanced Notification Styles */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-info {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar select,
        .filter-bar input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .large-modal .modal-content {
            max-width: 700px;
            width: 90%;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .stats-overview {
            margin-bottom: 30px;
        }

        .stats-section {
            margin-bottom: 25px;
        }

        .stats-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .stat-item strong {
            display: block;
            font-size: 1.5em;
            color: #3498db;
            margin-bottom: 5px;
        }

        .type-stats, .recent-notifications {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .type-stat, .recent-notification {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .page-info {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Status badge enhancements */
        .status-error {
            background: #e74c3c;
            color: white;
        }

        .status-warning {
            background: #f39c12;
            color: white;
        }

        /* Mobile responsiveness for notification table */
        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-bar select,
            .filter-bar input {
                width: 100%;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }

            .form-row {
                flex-direction: column;
            }

            .large-modal .modal-content {
                width: 95%;
                margin: 20px auto;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="logo-section">
            <div class="logo">☕</div>
            <h1>Qahwat Al Emarat</h1>
            <p style="color: #666; font-size: 1.1rem;">Admin Panel</p>
        </div>

        <div id="errorMessage" class="error-message">
            Invalid username or password
        </div>

        <form id="adminLoginForm">
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input type="text" id="username" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" required>
            </div>

            <button type="submit" class="btn-primary" id="loginBtn" style="width: 100%; padding: 14px; font-size: 1.1rem;">
                Login to Admin Panel
            </button>
        </form>
    </div>

    <!-- Main Admin Interface -->
    <div id="adminInterface" class="admin-container" style="display: none;">
        <header class="admin-header">
            <h1>☕ Qahwat Al Emarat Admin Panel</h1>
            <div class="header-actions">
                <span id="admin-status">Not Connected</span>
                <button id="connect-btn" class="btn-primary">Connect to Backend</button>
                <button onclick="logout()" class="btn-danger">Logout</button>
            </div>
        </header>

        <nav class="admin-nav">
            <button class="nav-btn active" data-section="dashboard">Dashboard</button>
            <button class="nav-btn" data-section="users">Users</button>
            <button class="nav-btn" data-section="categories">Categories</button>
            <button class="nav-btn" data-section="coffees">Coffees</button>
            <button class="nav-btn" data-section="sliders">Sliders</button>
            <button class="nav-btn" data-section="notifications">Notifications</button>
            <button class="nav-btn" data-section="orders">Orders</button>
            <button class="nav-btn" data-section="settings">Settings</button>
            <button class="nav-btn" data-section="system">System</button>
            <button class="nav-btn" data-section="analytics">Analytics</button>
        </nav>

        <main class="admin-main">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="stat-number" id="total-users">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Orders</h3>
                        <div class="stat-number" id="total-orders">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="stat-number" id="total-revenue">$-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Coffees</h3>
                        <div class="stat-number" id="active-coffees">-</div>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="content-section">
                <h2>User Management</h2>
                
                <!-- User Statistics -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="stat-number" id="user-total-count">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="stat-number" id="user-active-count">-</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.5rem;" id="user-active-percentage">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>New Today</h3>
                        <div class="stat-number" id="user-new-today">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>New This Week</h3>
                        <div class="stat-number" id="user-new-week">-</div>
                    </div>
                </div>

                <!-- User Filters -->
                <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="user-search">Search Users</label>
                            <input type="text" id="user-search" placeholder="Search by name or email...">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="user-role-filter">Role</label>
                            <select id="user-role-filter">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="user-status-filter">Status</label>
                            <select id="user-status-filter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div>
                            <button id="search-users" class="btn-primary">Search</button>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button id="clear-user-filters" class="btn-secondary">Clear Filters</button>
                        <button id="refresh-users" class="btn-secondary">Refresh</button>
                        <button id="export-users" class="btn-secondary">Export CSV</button>
                    </div>
                </div>

                <div class="data-table">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="7" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="user-pagination" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div id="user-pagination-info" style="color: #7f8c8d;">Showing 0 of 0 users</div>
                    <div id="user-pagination-controls">
                        <button id="user-prev-page" class="btn-secondary" disabled>Previous</button>
                        <span id="user-page-numbers" style="margin: 0 1rem;"></span>
                        <button id="user-next-page" class="btn-secondary" disabled>Next</button>
                    </div>
                </div>
            </section>

            <!-- Categories Section -->
            <section id="categories-section" class="content-section">
                <h2>Category Management</h2>
                <div class="section-actions">
                    <button id="add-category" class="btn-primary">Add Category</button>
                    <button id="refresh-categories" class="btn-secondary">Refresh</button>
                </div>
                <div class="data-table">
                    <table id="categories-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Color</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categories-tbody">
                            <tr>
                                <td colspan="6" class="loading">Loading categories...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Coffees Section -->
            <section id="coffees-section" class="content-section">
                <h2>Coffee Management</h2>
                <div class="section-actions">
                    <button id="add-coffee" class="btn-primary">Add Coffee</button>
                    <button id="refresh-coffees" class="btn-secondary">Refresh</button>
                </div>
                <div class="data-table">
                    <table id="coffees-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Sizes & Prices</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coffees-tbody">
                            <tr>
                                <td colspan="6" class="loading">Loading coffees...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sliders Section -->
            <section id="sliders-section" class="content-section">
                <h2>Slider Management</h2>
                <div class="section-actions">
                    <button id="add-slider" class="btn-primary">Add Slider</button>
                    <button id="refresh-sliders" class="btn-secondary">Refresh</button>
                </div>
                <div class="data-table">
                    <table id="sliders-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Views</th>
                                <th>Clicks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sliders-tbody">
                            <tr>
                                <td colspan="6" class="loading">Loading sliders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications-section" class="content-section">
                <h2>Push Notifications & Communication</h2>
                
                <!-- Notification Stats -->
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3 id="total-notifications">0</h3>
                        <p>Total Notifications</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="sent-notifications">0</h3>
                        <p>Sent</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="scheduled-notifications">0</h3>
                        <p>Scheduled</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="delivery-rate">0%</h3>
                        <p>Delivery Rate</p>
                    </div>
                </div>

                <div class="section-actions">
                    <button id="add-notification" class="btn-primary">Create Notification</button>
                    <button id="send-test-notification" class="btn-success">Send Test</button>
                    <button id="refresh-notifications" class="btn-secondary">Refresh</button>
                    <button id="notification-stats" class="btn-info">View Stats</button>
                </div>

                <!-- Notification Filters -->
                <div class="filter-bar" style="margin-bottom: 15px;">
                    <select id="notification-status-filter">
                        <option value="">All Statuses</option>
                        <option value="draft">Draft</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="sent">Sent</option>
                        <option value="failed">Failed</option>
                    </select>
                    <select id="notification-type-filter">
                        <option value="">All Types</option>
                        <option value="info">Info</option>
                        <option value="success">Success</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                        <option value="promotion">Promotion</option>
                        <option value="update">Update</option>
                        <option value="reminder">Reminder</option>
                    </select>
                    <input type="text" id="notification-search" placeholder="Search notifications...">
                    <button id="apply-notification-filters" class="btn-secondary">Filter</button>
                    <button id="clear-notification-filters" class="btn-secondary">Clear</button>
                </div>

                <div class="data-table">
                    <table id="notifications-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Message</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Target</th>
                                <th>Scheduled</th>
                                <th>Sent</th>
                                <th>Delivery Stats</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notifications-tbody">
                            <tr>
                                <td colspan="9" class="loading">Loading notifications...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="notification-pagination" style="margin-top: 20px;">
                    <button id="notification-prev-page" class="btn-secondary">Previous</button>
                    <span id="notification-page-info" class="page-info">Page 1 of 1</span>
                    <button id="notification-next-page" class="btn-secondary">Next</button>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders-section" class="content-section">
                <h2>Order Management</h2>
                <div class="section-actions">
                    <button id="refresh-orders" class="btn-secondary">Refresh</button>
                </div>
                <div class="data-table">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr>
                                <td colspan="7" class="loading">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="content-section">
                <h2>Application Settings</h2>
                
                <!-- Settings Categories -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="nav-btn settings-category-btn active" data-category="general">General</button>
                        <button class="nav-btn settings-category-btn" data-category="business">Business</button>
                        <button class="nav-btn settings-category-btn" data-category="email">Email</button>
                        <button class="nav-btn settings-category-btn" data-category="payment">Payment</button>
                        <button class="nav-btn settings-category-btn" data-category="social">Social Media</button>
                        <button class="nav-btn settings-category-btn" data-category="notification">Notifications</button>
                    </div>
                </div>

                <!-- Settings Form -->
                <div class="data-table">
                    <div style="padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3 id="settings-category-title">General Settings</h3>
                            <div>
                                <button id="save-settings" class="btn-primary">Save Settings</button>
                                <button id="reset-settings" class="btn-secondary">Reset to Defaults</button>
                            </div>
                        </div>
                        
                        <form id="settings-form">
                            <div id="settings-fields">
                                <div class="loading" style="text-align: center; padding: 2rem;">Loading settings...</div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- System Management Section -->
            <section id="system-section" class="content-section">
                <h2>System Management</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <h3>System Status</h3>
                        <div class="stat-number" id="system-status" style="font-size: 1.5rem; color: #27ae60;">Running</div>
                    </div>
                    <div class="stat-card">
                        <h3>Database Status</h3>
                        <div class="stat-number" id="db-status" style="font-size: 1.5rem; color: #27ae60;">Connected</div>
                    </div>
                    <div class="stat-card">
                        <h3>Admin Actions Today</h3>
                        <div class="stat-number" id="admin-actions-today">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Admin Logs</h3>
                        <div class="stat-number" id="total-admin-logs">-</div>
                    </div>
                </div>

                <!-- System Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <div class="data-table">
                        <div style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 1rem;">Database Management</h3>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button id="initialize-settings" class="btn-secondary" style="width: 100%;">Initialize Default Settings</button>
                                <button id="backup-database" class="btn-secondary" style="width: 100%;">Create Database Backup</button>
                                <button id="clear-cache" class="btn-secondary" style="width: 100%;">Clear Application Cache</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table">
                        <div style="padding: 1.5rem;">
                            <h3 style="margin-bottom: 1rem;">Admin Activity</h3>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button id="view-admin-logs" class="btn-secondary" style="width: 100%;">View Admin Activity Logs</button>
                                <button id="export-admin-logs" class="btn-secondary" style="width: 100%;">Export Activity Logs</button>
                                <button id="clear-old-logs" class="btn-secondary" style="width: 100%;">Clear Old Logs (>30 days)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Admin Activity -->
                <div class="data-table">
                    <h3 style="padding: 1rem 1rem 0;">Recent Admin Activity</h3>
                    <table id="admin-logs-table">
                        <thead>
                            <tr>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>Details</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="admin-logs-tbody">
                            <tr>
                                <td colspan="5" class="loading">Loading recent activity...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics-section" class="content-section">
                <h2>Analytics & Reports</h2>
                
                <!-- Analytics Overview -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="stat-number" id="analytics-revenue">AED 0</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.5rem;">Last 30 days</div>
                    </div>
                    <div class="stat-card">
                        <h3>Orders This Month</h3>
                        <div class="stat-number" id="analytics-orders">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Average Order Value</h3>
                        <div class="stat-number" id="analytics-aov">AED 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Customer Growth</h3>
                        <div class="stat-number" id="analytics-growth">+0%</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.5rem;">vs last month</div>
                    </div>
                </div>

                <!-- Charts Placeholder -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="data-table">
                        <div style="padding: 2rem; text-align: center;">
                            <h3>Sales Chart</h3>
                            <p style="color: #7f8c8d;">Daily sales chart will be displayed here</p>
                            <div style="height: 200px; background: #f8f9fa; border-radius: 4px; margin-top: 1rem; display: flex; align-items: center; justify-content: center;">
                                📈 Chart Coming Soon
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table">
                        <div style="padding: 2rem; text-align: center;">
                            <h3>Top Products</h3>
                            <p style="color: #7f8c8d;">Best selling products chart</p>
                            <div style="height: 200px; background: #f8f9fa; border-radius: 4px; margin-top: 1rem; display: flex; align-items: center; justify-content: center;">
                                📊 Chart Coming Soon
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="data-table">
                    <div style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1rem;">Export Reports</h3>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button id="export-sales-report" class="btn-secondary">Export Sales Report</button>
                            <button id="export-customer-report" class="btn-secondary">Export Customer Report</button>
                            <button id="export-product-report" class="btn-secondary">Export Product Report</button>
                            <button id="export-financial-report" class="btn-secondary">Export Financial Report</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Coffee Modal -->
    <div id="coffee-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-title">Add Coffee</h2>
            <form id="coffee-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="coffee-name">Name:</label>
                    <input type="text" id="coffee-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="coffee-description">Description:</label>
                    <textarea id="coffee-description" name="description" required></textarea>
                </div>
                
                <!-- Size and Pricing Section -->
                <div class="form-group">
                    <label style="font-weight: bold; margin-bottom: 1rem; display: block;">Size & Pricing:</label>
                    
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">250g Package</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label for="price-250g">Price (AED):</label>
                                <input type="number" id="price-250g" name="price250g" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div>
                                <label for="stock-250g">Stock:</label>
                                <input type="number" id="stock-250g" name="stock250g" min="0" value="10" placeholder="10">
                            </div>
                        </div>
                    </div>
                    
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">500g Package</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label for="price-500g">Price (AED):</label>
                                <input type="number" id="price-500g" name="price500g" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div>
                                <label for="stock-500g">Stock:</label>
                                <input type="number" id="stock-500g" name="stock500g" min="0" value="10" placeholder="10">
                            </div>
                        </div>
                    </div>
                    
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">1kg Package</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label for="price-1kg">Price (AED):</label>
                                <input type="number" id="price-1kg" name="price1kg" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div>
                                <label for="stock-1kg">Stock:</label>
                                <input type="number" id="stock-1kg" name="stock1kg" min="0" value="10" placeholder="10">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="coffee-category">Category:</label>
                    <select id="coffee-category" name="category" required>
                        <option value="">Loading categories...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="coffee-origin">Origin:</label>
                    <input type="text" id="coffee-origin" name="origin" required placeholder="e.g., Brazil, Ethiopia, Colombia">
                </div>
                <div class="form-group">
                    <label for="coffee-roast">Roast Level:</label>
                    <select id="coffee-roast" name="roastLevel" required>
                        <option value="Light">Light</option>
                        <option value="Medium-Light">Medium-Light</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Medium-Dark">Medium-Dark</option>
                        <option value="Dark">Dark</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="coffee-image">Coffee Image:</label>
                    <input type="file" id="coffee-image" name="image" accept="image/*" required>
                    <small class="form-hint">Supported formats: JPG, PNG, GIF (Max: 5MB)</small>
                </div>
                <button type="submit" class="btn-primary">Save Coffee</button>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="category-modal-title">Add Category</h2>
            <form id="category-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="category-name">Name:</label>
                    <input type="text" id="category-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="category-description">Description:</label>
                    <textarea id="category-description" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="category-color">Color:</label>
                    <input type="color" id="category-color" name="color" value="#8B4513">
                </div>
                <div class="form-group">
                    <label for="category-image">Category Image (Optional):</label>
                    <input type="file" id="category-image" name="image" accept="image/*">
                    <small class="form-hint">Supported formats: JPG, PNG, GIF (Max: 5MB)</small>
                </div>
                <button type="submit" class="btn-primary">Save Category</button>
            </form>
        </div>
    </div>

    <!-- Slider Modal -->
    <div id="slider-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="slider-modal-title">Add Slider</h2>
            <form id="slider-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="slider-title">Title:</label>
                    <input type="text" id="slider-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="slider-description">Description:</label>
                    <textarea id="slider-description" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="slider-image">Slider Image:</label>
                    <input type="file" id="slider-image" name="image" accept="image/*" required>
                    <small class="form-hint">Supported formats: JPG, PNG, GIF (Max: 10MB)</small>
                </div>
                <div class="form-group">
                    <label for="slider-button-text">Button Text (Optional):</label>
                    <input type="text" id="slider-button-text" name="buttonText">
                </div>
                <div class="form-group">
                    <label for="slider-button-link">Button Link (Optional):</label>
                    <input type="url" id="slider-button-link" name="buttonLink">
                </div>
                <button type="submit" class="btn-primary">Save Slider</button>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="user-modal-title">Edit User</h2>
            <form id="user-form">
                <input type="hidden" id="user-id" name="id">
                <div class="form-group">
                    <label for="user-name">Full Name:</label>
                    <input type="text" id="user-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="user-email">Email:</label>
                    <input type="email" id="user-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="user-phone">Phone (Optional):</label>
                    <input type="tel" id="user-phone" name="phone">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem;">Roles:</label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                            <input type="checkbox" id="role-customer" name="roles" value="customer">
                            Customer
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                            <input type="checkbox" id="role-admin" name="roles" value="admin">
                            Admin
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                        <input type="checkbox" id="user-active" name="isActive">
                        Active User
                    </label>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" onclick="window.adminPanel.closeModal('user-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Delete Confirmation Modal -->
    <div id="user-delete-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close">&times;</span>
            <h2 style="color: #e74c3c; margin-bottom: 1rem;">⚠️ Delete User</h2>
            <p>Are you sure you want to delete this user?</p>
            <div id="user-delete-info" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                <!-- User info will be populated -->
            </div>
            <p style="color: #e74c3c; font-size: 0.9rem;">⚠️ This action cannot be undone. All user data will be permanently deleted.</p>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" onclick="window.adminPanel.closeModal('user-delete-modal')" class="btn-secondary">Cancel</button>
                <button type="button" id="confirm-user-delete" class="btn-danger">Delete User</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal">
        <div class="modal-content large-modal">
            <span class="close">&times;</span>
            <h2 id="notification-modal-title">Create Notification</h2>
            <form id="notification-form" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group">
                        <label for="notification-title">Title:</label>
                        <input type="text" id="notification-title" name="title" required maxlength="100">
                        <small class="form-hint">Maximum 100 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="notification-type">Type:</label>
                        <select id="notification-type" name="type">
                            <option value="info">Info</option>
                            <option value="success">Success</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="promotion">Promotion</option>
                            <option value="update">Update</option>
                            <option value="reminder">Reminder</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notification-message">Message:</label>
                    <textarea id="notification-message" name="message" required maxlength="500" rows="4"></textarea>
                    <small class="form-hint">Maximum 500 characters</small>
                </div>

                <!-- Target Audience -->
                <div class="form-group">
                    <label>Target Audience:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="targetAudience" value="all" checked> All Users</label>
                        <label><input type="checkbox" name="targetAudience" value="new-customers"> New Customers</label>
                        <label><input type="checkbox" name="targetAudience" value="returning-customers"> Returning Customers</label>
                        <label><input type="checkbox" name="targetAudience" value="loyal-customers"> Loyal Customers</label>
                        <label><input type="checkbox" name="targetAudience" value="specific-users"> Specific Users</label>
                    </div>
                </div>

                <!-- Priority -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="notification-priority">Priority:</label>
                        <select id="notification-priority" name="priority">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notification-platform">Platform:</label>
                        <select id="notification-platform" name="platform">
                            <option value="all" selected>All Platforms</option>
                            <option value="mobile">Mobile Only</option>
                            <option value="web">Web Only</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notification-scheduled-date">Schedule Date (Optional):</label>
                    <input type="datetime-local" id="notification-scheduled-date" name="scheduledDate">
                    <small class="form-hint">Leave empty to send immediately</small>
                </div>

                <!-- Action Button -->
                <div class="form-group">
                    <label>Action Button (Optional):</label>
                    <div class="form-row">
                        <input type="text" id="notification-action-text" name="actionText" placeholder="Button Text" maxlength="50">
                        <input type="url" id="notification-action-link" name="actionLink" placeholder="https://example.com">
                    </div>
                </div>

                <div class="form-group">
                    <label for="notification-image">Image (Optional):</label>
                    <input type="file" id="notification-image" name="image" accept="image/*">
                    <small class="form-hint">Supported formats: JPG, PNG, GIF (Max: 5MB)</small>
                </div>

                <!-- Tags -->
                <div class="form-group">
                    <label for="notification-tags">Tags (Optional):</label>
                    <input type="text" id="notification-tags" name="tags" placeholder="Enter tags separated by commas">
                    <small class="form-hint">Used for filtering and analytics</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.adminPanel.closeModal('notification-modal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save Notification</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Notification Modal -->
    <div id="test-notification-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Send Test Notification</h2>
            <form id="test-notification-form">
                <div class="form-group">
                    <label for="test-title">Title:</label>
                    <input type="text" id="test-title" name="title" required placeholder="Test Notification">
                </div>
                <div class="form-group">
                    <label for="test-message">Message:</label>
                    <textarea id="test-message" name="message" required placeholder="This is a test notification"></textarea>
                </div>
                <div class="form-group">
                    <label for="test-target">Send To:</label>
                    <select id="test-target" name="target">
                        <option value="all">All Users</option>
                        <option value="topic">Topic Subscribers</option>
                        <option value="devices">Specific Devices</option>
                    </select>
                </div>
                <div class="form-group" id="test-topic-group" style="display: none;">
                    <label for="test-topic">Topic Name:</label>
                    <input type="text" id="test-topic" name="topic" placeholder="notifications">
                </div>
                <div class="form-group" id="test-devices-group" style="display: none;">
                    <label for="test-devices">Device Tokens:</label>
                    <textarea id="test-devices" name="deviceTokens" placeholder="Enter device tokens separated by commas"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.adminPanel.closeModal('test-notification-modal')">Cancel</button>
                    <button type="submit" class="btn-success">Send Test</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Stats Modal -->
    <div id="notification-stats-modal" class="modal">
        <div class="modal-content large-modal">
            <span class="close">&times;</span>
            <h2>Notification Statistics</h2>
            <div id="notification-stats-content">
                <div class="loading">Loading statistics...</div>
            </div>
        </div>
    </div>

    <script>
        // Admin Panel JavaScript
        class WebAdminPanel {
            constructor() {
                this.apiBaseUrl = 'https://qahwatapp.onrender.com/api';
                this.publicAdminUrl = 'https://qahwatapp.onrender.com/api/public-admin';
                this.isConnected = false;
                this.currentSection = 'dashboard';
                this.currentUserPage = 1;
                this.currentNotificationPage = 1;
                this.userToDelete = null;
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkLoginState();
            }

            bindEvents() {
                // Login form
                const loginForm = document.getElementById('adminLoginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    // Skip settings category buttons as they have their own event listeners
                    if (btn.classList.contains('settings-category-btn')) {
                        return;
                    }
                    
                    btn.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        if (section) {
                            this.switchSection(section);
                        } else {
                            console.error('No section data found on button:', e.target);
                        }
                    });
                });

                // Connect button
                const connectBtn = document.getElementById('connect-btn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', () => {
                        this.checkConnection();
                    });
                }

                // User management buttons
                document.getElementById('refresh-users')?.addEventListener('click', () => {
                    this.loadUsers();
                });

                document.getElementById('search-users')?.addEventListener('click', () => {
                    this.searchUsers();
                });

                document.getElementById('clear-user-filters')?.addEventListener('click', () => {
                    this.clearUserFilters();
                });

                document.getElementById('export-users')?.addEventListener('click', () => {
                    this.exportUsers();
                });

                document.getElementById('user-prev-page')?.addEventListener('click', () => {
                    if (this.currentUserPage > 1) {
                        this.loadUsers(this.currentUserPage - 1);
                    }
                });

                document.getElementById('user-next-page')?.addEventListener('click', () => {
                    this.loadUsers(this.currentUserPage + 1);
                });

                // User form
                document.getElementById('user-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveUser();
                });

                document.getElementById('confirm-user-delete')?.addEventListener('click', () => {
                    this.deleteUser();
                });

                // Enter key search for users
                document.getElementById('user-search')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchUsers();
                    }
                });

                // Settings event listeners
                document.querySelectorAll('.settings-category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const category = e.target.dataset.category;
                        this.switchSettingsCategory(category);
                    });
                });

                document.getElementById('save-settings')?.addEventListener('click', () => {
                    this.saveSettings();
                });

                document.getElementById('reset-settings')?.addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                        this.resetSettings();
                    }
                });

                // System management event listeners
                document.getElementById('initialize-settings')?.addEventListener('click', () => {
                    this.initializeSettings();
                });

                document.getElementById('view-admin-logs')?.addEventListener('click', () => {
                    this.loadAdminLogs(1, 50); // Load more logs
                });

                document.getElementById('export-admin-logs')?.addEventListener('click', () => {
                    this.exportAdminLogs();
                });

                document.getElementById('clear-old-logs')?.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear admin logs older than 30 days?')) {
                        this.clearOldLogs();
                    }
                });

                document.getElementById('refresh-coffees')?.addEventListener('click', () => {
                    this.loadCoffees();
                });

                document.getElementById('refresh-orders')?.addEventListener('click', () => {
                    this.loadOrders();
                });

                // Add coffee button
                document.getElementById('add-coffee')?.addEventListener('click', () => {
                    this.openCoffeeModal();
                });

                // Category buttons
                document.getElementById('add-category')?.addEventListener('click', () => {
                    this.openCategoryModal();
                });

                document.getElementById('refresh-categories')?.addEventListener('click', () => {
                    this.loadCategories();
                });

                // Slider buttons
                document.getElementById('add-slider')?.addEventListener('click', () => {
                    this.openSliderModal();
                });

                document.getElementById('refresh-sliders')?.addEventListener('click', () => {
                    this.loadSliders();
                });

                // Notification buttons
                document.getElementById('add-notification')?.addEventListener('click', () => {
                    this.openNotificationModal();
                });

                document.getElementById('refresh-notifications')?.addEventListener('click', () => {
                    this.loadNotifications();
                    this.loadNotificationStats();
                });

                document.getElementById('send-test-notification')?.addEventListener('click', () => {
                    this.openTestNotificationModal();
                });

                document.getElementById('notification-stats')?.addEventListener('click', () => {
                    this.showNotificationStats();
                });

                document.getElementById('apply-notification-filters')?.addEventListener('click', () => {
                    this.loadNotifications(1, true);
                });

                document.getElementById('clear-notification-filters')?.addEventListener('click', () => {
                    this.clearNotificationFilters();
                });

                document.getElementById('notification-prev-page')?.addEventListener('click', () => {
                    if (this.currentNotificationPage > 1) {
                        this.currentNotificationPage--;
                        this.loadNotifications(this.currentNotificationPage);
                    }
                });

                document.getElementById('notification-next-page')?.addEventListener('click', () => {
                    this.currentNotificationPage++;
                    this.loadNotifications(this.currentNotificationPage);
                });

                // Test notification form
                document.getElementById('test-notification-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendTestNotification();
                });

                document.getElementById('test-target')?.addEventListener('change', (e) => {
                    this.toggleTestTargetFields(e.target.value);
                });

                // Coffee form
                document.getElementById('coffee-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCoffee();
                });

                // Category form
                document.getElementById('category-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCategory();
                });

                // Slider form
                document.getElementById('slider-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSlider();
                });

                // Notification form
                document.getElementById('notification-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveNotification();
                });

                // Modal close
                document.querySelectorAll('.close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', (e) => {
                        const modal = e.target.closest('.modal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            checkLoginState() {
                if (localStorage.getItem('adminLoggedIn') === 'true') {
                    this.showAdminInterface();
                }
            }

            handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');
                const errorMessage = document.getElementById('errorMessage');

                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';

                // Simple authentication (in production, use proper backend authentication)
                setTimeout(() => {
                    if (username === 'admin' && password === 'qahwat2024') {
                        localStorage.setItem('adminLoggedIn', 'true');
                        this.showAdminInterface();
                        errorMessage.style.display = 'none';
                    } else {
                        errorMessage.style.display = 'block';
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login to Admin Panel';
                    }
                }, 1000);
            }

            showAdminInterface() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminInterface').style.display = 'flex';
                this.checkConnection();
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.apiBaseUrl.replace('/api', '')}/health`);
                    if (response.ok) {
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        this.loadDashboardData();
                    } else {
                        throw new Error('Backend not responding');
                    }
                } catch (error) {
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    console.error('Connection check failed:', error);
                }
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('admin-status');
                const connectBtn = document.getElementById('connect-btn');

                if (connected) {
                    statusEl.textContent = 'Connected';
                    statusEl.style.background = 'rgba(39, 174, 96, 0.2)';
                    statusEl.style.color = '#27ae60';
                    connectBtn.textContent = 'Refresh Connection';
                } else {
                    statusEl.textContent = 'Not Connected';
                    statusEl.style.background = 'rgba(231, 76, 60, 0.2)';
                    statusEl.style.color = '#e74c3c';
                    connectBtn.textContent = 'Connect to Backend';
                }
            }

            switchSection(section) {
                // Update navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const navBtn = document.querySelector(`[data-section="${section}"]`);
                if (navBtn) {
                    navBtn.classList.add('active');
                } else {
                    console.warn(`Navigation button for section "${section}" not found`);
                }

                // Update content
                document.querySelectorAll('.content-section').forEach(sec => {
                    sec.classList.remove('active');
                });
                
                const contentSection = document.getElementById(`${section}-section`);
                if (contentSection) {
                    contentSection.classList.add('active');
                } else {
                    console.warn(`Content section "${section}-section" not found`);
                }

                this.currentSection = section;

                // Load data for the section
                if (this.isConnected) {
                    switch (section) {
                        case 'users':
                            this.loadUsers();
                            this.loadUserStats();
                            break;
                        case 'categories':
                            this.loadCategories();
                            break;
                        case 'coffees':
                            this.loadCoffees();
                            break;
                        case 'sliders':
                            this.loadSliders();
                            break;
                        case 'notifications':
                            this.loadNotifications();
                            this.loadNotificationStats();
                            break;
                        case 'orders':
                            this.loadOrders();
                            break;
                        case 'settings':
                            this.loadSettings();
                            break;
                        case 'system':
                            this.loadSystemInfo();
                            this.loadAdminLogs();
                            break;
                        case 'analytics':
                            this.loadAnalytics();
                            break;
                    }
                }
            }

            async loadDashboardData() {
                if (!this.isConnected) return;

                try {
                    // Load coffee stats
                    const coffeeStatsResponse = await fetch(`${this.apiBaseUrl}/coffees/stats`);
                    if (coffeeStatsResponse.ok) {
                        const coffeeStats = await coffeeStatsResponse.json();
                        if (coffeeStats.success) {
                            document.getElementById('active-coffees').textContent = coffeeStats.data.overview.activeCoffees || 0;
                        }
                    }

                    // For now, set other stats to 0 until we implement those endpoints
                    document.getElementById('total-users').textContent = '0';
                    document.getElementById('total-orders').textContent = '0';
                    document.getElementById('total-revenue').textContent = '$0';

                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }

            async loadUsers(page = 1, limit = 10) {
                if (!this.isConnected) return;

                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading users...</td></tr>';

                try {
                    // Build query parameters
                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: limit.toString()
                    });

                    // Add filters if they exist
                    const searchValue = document.getElementById('user-search')?.value;
                    const roleFilter = document.getElementById('user-role-filter')?.value;
                    const statusFilter = document.getElementById('user-status-filter')?.value;

                    if (searchValue) params.append('search', searchValue);
                    if (roleFilter) params.append('role', roleFilter);
                    if (statusFilter) params.append('status', statusFilter);

                    const response = await fetch(`${this.publicAdminUrl}/users?${params}`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        this.renderUsersTable(result.data.users || result.users || []);
                        this.updateUserPagination(result.data.pagination || result.pagination || {});
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; color: #e74c3c;">
                                    Failed to load users: ${result.message || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #e74c3c;">
                                Failed to load users: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            async loadUserStats() {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/users/stats`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const stats = result.data;
                        document.getElementById('user-total-count').textContent = stats.totalUsers || 0;
                        document.getElementById('user-active-count').textContent = stats.activeUsers || 0;
                        document.getElementById('user-new-today').textContent = stats.newUsersToday || 0;
                        document.getElementById('user-new-week').textContent = stats.newUsersThisWeek || 0;
                        
                        // Calculate percentage
                        const percentage = stats.totalUsers > 0 ? 
                            ((stats.activeUsers / stats.totalUsers) * 100).toFixed(1) : 0;
                        document.getElementById('user-active-percentage').textContent = `${percentage}%`;
                    }
                } catch (error) {
                    console.error('Failed to load user stats:', error);
                }
            }

            renderUsersTable(users) {
                const tbody = document.getElementById('users-tbody');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #7f8c8d;">
                                No users found matching your criteria.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = users.map(user => {
                    const lastLogin = user.lastLogin ? 
                        new Date(user.lastLogin).toLocaleDateString() : 'Never';
                    const created = new Date(user.createdAt).toLocaleDateString();
                    const roles = Array.isArray(user.roles) ? user.roles.join(', ') : (user.roles || 'customer');

                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #8B4513, #D2691E); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        ${user.name ? user.name.charAt(0).toUpperCase() : '?'}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500;">${user.name || 'N/A'}</div>
                                        ${user.phone ? `<div style="font-size: 0.8rem; color: #666;">${user.phone}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>${user.email}</div>
                                ${!user.isEmailVerified ? '<div style="color: #f39c12; font-size: 0.8rem;">⚠️ Unverified</div>' : ''}
                            </td>
                            <td>
                                <span class="status-badge ${roles.includes('admin') ? 'status-completed' : 'status-active'}">
                                    ${roles}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                                    ${user.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>${lastLogin}</td>
                            <td>${created}</td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" 
                                            onclick="window.adminPanel.editUser('${user._id || user.id}')">
                                        Edit
                                    </button>
                                    <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" 
                                            onclick="window.adminPanel.toggleUserStatus('${user._id || user.id}', ${!user.isActive})">
                                        ${user.isActive ? 'Deactivate' : 'Activate'}
                                    </button>
                                    <button class="btn-danger" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"
                                            onclick="window.adminPanel.confirmDeleteUser('${user._id || user.id}', '${user.name}', '${user.email}')">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateUserPagination(pagination) {
                const currentPage = pagination.currentPage || 1;
                const totalPages = pagination.totalPages || 1;
                const totalUsers = pagination.totalUsers || 0;
                const limit = pagination.limit || 10;

                // Update info
                document.getElementById('user-pagination-info').textContent = 
                    `Showing ${Math.min((currentPage - 1) * limit + 1, totalUsers)}-${Math.min(currentPage * limit, totalUsers)} of ${totalUsers} users`;

                // Update controls
                const prevBtn = document.getElementById('user-prev-page');
                const nextBtn = document.getElementById('user-next-page');
                const pageNumbers = document.getElementById('user-page-numbers');

                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;

                // Generate page numbers
                let pages = '';
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);

                for (let i = startPage; i <= endPage; i++) {
                    pages += `<button class="btn-${i === currentPage ? 'primary' : 'secondary'}" 
                                     style="padding: 0.3rem 0.6rem; margin: 0 0.2rem; font-size: 0.8rem;"
                                     onclick="window.adminPanel.loadUsers(${i})">${i}</button>`;
                }
                pageNumbers.innerHTML = pages;

                // Store current page for other functions
                this.currentUserPage = currentPage;
            }

            async loadCoffees() {
                if (!this.isConnected) return;

                const tbody = document.getElementById('coffees-tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading coffees...</td></tr>';

                try {
                    const response = await fetch(`${this.apiBaseUrl}/coffees`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        if (result.data.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #7f8c8d;">
                                        No coffees found. Click "Add Coffee" to create your first coffee.
                                    </td>
                                </tr>
                            `;
                        } else {
                            tbody.innerHTML = result.data.map(coffee => {
                                // Display variant pricing if available
                                let priceDisplay = '';
                                if (coffee.variants && coffee.variants.length > 0) {
                                    priceDisplay = coffee.variants.map(variant => 
                                        `<div style="font-size: 0.85em; margin: 2px 0;">
                                            <strong>${variant.size}:</strong> ${variant.price.toFixed(2)} AED 
                                            <span style="color: #666;">(Stock: ${variant.stock})</span>
                                        </div>`
                                    ).join('');
                                } else {
                                    priceDisplay = `<div>${coffee.price.toFixed(2)} AED</div>`;
                                }
                                
                                return `
                                    <tr>
                                        <td><img src="${this.apiBaseUrl.replace('/api', '')}${coffee.image}" alt="${coffee.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                                        <td>
                                            <div style="font-weight: 500;">${coffee.name}</div>
                                            <div style="font-size: 0.8em; color: #666;">${coffee.origin || 'Unknown Origin'}</div>
                                        </td>
                                        <td>${coffee.categories ? coffee.categories.join(', ') : 'N/A'}</td>
                                        <td>${priceDisplay}</td>
                                        <td>
                                            <span class="status-badge ${coffee.isActive ? 'status-active' : 'status-inactive'}">
                                                ${coffee.isActive ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn-danger" onclick="window.adminPanel.deleteCoffee('${coffee._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');
                        }
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; color: #e74c3c;">
                                    Failed to load coffees: ${result.message || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #e74c3c;">
                                Failed to load coffees: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            async loadOrders() {
                if (!this.isConnected) return;

                const tbody = document.getElementById('orders-tbody');
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading orders...</td></tr>';

                try {
                    const response = await fetch(`${this.publicAdminUrl}/orders`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const orders = result.data.orders || [];
                        
                        if (orders.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #7f8c8d;">
                                        No orders found. Orders will appear here when customers place them.
                                    </td>
                                </tr>
                            `;
                            return;
                        }

                        tbody.innerHTML = orders.map(order => {
                            const customerName = order.user?.name || order.guestInfo?.name || 'Guest';
                            const customerEmail = order.user?.email || order.guestInfo?.email || 'N/A';
                            
                            const items = order.items.map(item => 
                                `${item.name} (${item.selectedSize || 'N/A'}) x${item.quantity}`
                            ).join(', ');

                            const statusColors = {
                                pending: 'status-pending',
                                confirmed: 'status-active',
                                preparing: 'status-pending',
                                ready: 'status-active',
                                delivered: 'status-completed',
                                cancelled: 'status-inactive'
                            };

                            return `
                                <tr>
                                    <td>
                                        <div style="font-weight: 500;">${order.orderNumber}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${order.paymentMethod}</div>
                                    </td>
                                    <td>
                                        <div>${customerName}</div>
                                        <div style="font-size: 0.8rem; color: #666;">${customerEmail}</div>
                                    </td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${items}">
                                        ${items}
                                    </td>
                                    <td>
                                        <div style="font-weight: 500;">${order.currency} ${order.totalAmount.toFixed(2)}</div>
                                        <div style="font-size: 0.8rem; color: #666;">Payment: ${order.paymentStatus}</div>
                                    </td>
                                    <td>
                                        <span class="status-badge ${statusColors[order.status] || 'status-pending'}">
                                            ${order.status}
                                        </span>
                                    </td>
                                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                    <td>
                                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                                            <select onchange="window.adminPanel.updateOrderStatus('${order._id}', this.value)" 
                                                    style="font-size: 0.8rem; padding: 0.2rem;">
                                                <option value="">Change Status</option>
                                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                            </select>
                                            <button class="btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.8rem;"
                                                    onclick="window.adminPanel.viewOrderDetails('${order._id}')">
                                                View
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; color: #e74c3c;">
                                    Failed to load orders: ${result.message || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #e74c3c;">
                                Failed to load orders: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            async updateOrderStatus(orderId, newStatus) {
                if (!newStatus || !this.isConnected) return;

                try {
                    const response = await fetch(`${this.publicAdminUrl}/orders/${orderId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            status: newStatus,
                            notes: `Status updated to ${newStatus} by admin`
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Order status updated successfully!');
                        this.loadOrders(); // Refresh the orders list
                    } else {
                        alert('Failed to update order status: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to update order status: ' + error.message);
                }
            }

            async viewOrderDetails(orderId) {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.publicAdminUrl}/orders/${orderId}`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const order = result.data;
                        
                        // Create a detailed order view (could be a modal or redirect)
                        alert(`Order Details:\n\n` +
                            `Order Number: ${order.orderNumber}\n` +
                            `Customer: ${order.user?.name || order.guestInfo?.name || 'Guest'}\n` +
                            `Status: ${order.status}\n` +
                            `Total: ${order.currency} ${order.totalAmount.toFixed(2)}\n` +
                            `Items: ${order.items.length}\n` +
                            `Date: ${new Date(order.createdAt).toLocaleString()}`
                        );
                    } else {
                        alert('Failed to load order details: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to load order details: ' + error.message);
                }
            }

            // Settings Management
            async loadSettings(category = 'general') {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.publicAdminUrl}/settings?category=${category}&includePrivate=true`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        this.currentSettingsCategory = category;
                        this.renderSettingsForm(result.data, category);
                    } else {
                        document.getElementById('settings-fields').innerHTML = `
                            <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                                Failed to load settings: ${result.message || 'Unknown error'}
                            </div>
                        `;
                    }
                } catch (error) {
                    document.getElementById('settings-fields').innerHTML = `
                        <div style="text-align: center; color: #e74c3c; padding: 2rem;">
                            Failed to load settings: ${error.message}
                        </div>
                    `;
                }
            }

            switchSettingsCategory(category) {
                // Update active category button
                document.querySelectorAll('.settings-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-category="${category}"]`).classList.add('active');

                // Update title
                const titles = {
                    general: 'General Settings',
                    business: 'Business Settings', 
                    email: 'Email Configuration',
                    payment: 'Payment Settings',
                    social: 'Social Media Links',
                    notification: 'Notification Settings'
                };
                document.getElementById('settings-category-title').textContent = titles[category] || 'Settings';

                // Load settings for category
                this.loadSettings(category);
            }

            renderSettingsForm(settings, category) {
                const fieldsContainer = document.getElementById('settings-fields');
                
                const categorySettings = settings[category] || {};
                
                if (Object.keys(categorySettings).length === 0) {
                    fieldsContainer.innerHTML = `
                        <div style="text-align: center; color: #7f8c8d; padding: 2rem;">
                            No settings found for this category.
                        </div>
                    `;
                    return;
                }

                const fields = Object.entries(categorySettings).map(([key, setting]) => {
                    const { value, dataType, description, isRequired } = setting;
                    const fieldId = `setting-${key}`;
                    
                    let inputElement = '';
                    
                    switch (dataType) {
                        case 'boolean':
                            inputElement = `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="${fieldId}" name="${key}" ${value ? 'checked' : ''}>
                                    <label for="${fieldId}" style="margin: 0; font-weight: normal;">Enable</label>
                                </div>
                            `;
                            break;
                        case 'number':
                            inputElement = `<input type="number" id="${fieldId}" name="${key}" value="${value}" ${isRequired ? 'required' : ''}>`;
                            break;
                        case 'array':
                            inputElement = `<input type="text" id="${fieldId}" name="${key}" value="${Array.isArray(value) ? value.join(', ') : value}" ${isRequired ? 'required' : ''} placeholder="Comma-separated values">`;
                            break;
                        default:
                            if (key.toLowerCase().includes('password') || key.toLowerCase().includes('secret') || key.toLowerCase().includes('key')) {
                                inputElement = `<input type="password" id="${fieldId}" name="${key}" value="${value}" ${isRequired ? 'required' : ''}>`;
                            } else if (description && description.toLowerCase().includes('url')) {
                                inputElement = `<input type="url" id="${fieldId}" name="${key}" value="${value}" ${isRequired ? 'required' : ''}>`;
                            } else if (key.toLowerCase().includes('email')) {
                                inputElement = `<input type="email" id="${fieldId}" name="${key}" value="${value}" ${isRequired ? 'required' : ''}>`;
                            } else {
                                inputElement = `<input type="text" id="${fieldId}" name="${key}" value="${value}" ${isRequired ? 'required' : ''}>`;
                            }
                    }

                    return `
                        <div class="form-group">
                            <label for="${fieldId}">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</label>
                            ${inputElement}
                            ${description ? `<small class="form-hint">${description}</small>` : ''}
                        </div>
                    `;
                }).join('');

                fieldsContainer.innerHTML = fields;
            }

            async saveSettings() {
                if (!this.isConnected) return;

                const form = document.getElementById('settings-form');
                const formData = new FormData(form);
                const settings = {};

                // Collect all form values
                for (const [key, value] of formData.entries()) {
                    const input = form.querySelector(`[name="${key}"]`);
                    
                    if (input.type === 'checkbox') {
                        settings[key] = input.checked;
                    } else if (input.type === 'number') {
                        settings[key] = parseFloat(value) || 0;
                    } else if (key.includes('array') || value.includes(',')) {
                        settings[key] = value.split(',').map(v => v.trim()).filter(v => v);
                    } else {
                        settings[key] = value;
                    }
                }

                try {
                    const response = await fetch(`${this.publicAdminUrl}/settings/bulk`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ settings })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Settings saved successfully!');
                        this.loadSettings(this.currentSettingsCategory);
                    } else {
                        alert('Failed to save settings: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to save settings: ' + error.message);
                }
            }

            async resetSettings() {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.publicAdminUrl}/settings/reset`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Settings reset to defaults successfully!');
                        this.loadSettings(this.currentSettingsCategory);
                    } else {
                        alert('Failed to reset settings: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to reset settings: ' + error.message);
                }
            }

            // System Management
            async loadSystemInfo() {
                if (!this.isConnected) return;

                try {
                    // Load audit log stats
                    const response = await fetch(`${this.apiBaseUrl}/admin/audit-logs/stats`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const stats = result.data;
                        document.getElementById('admin-actions-today').textContent = stats.actionsToday || 0;
                        document.getElementById('total-admin-logs').textContent = stats.totalLogs || 0;
                    }
                } catch (error) {
                    console.error('Failed to load system info:', error);
                }
            }

            async loadAdminLogs(page = 1, limit = 10) {
                if (!this.isConnected) return;

                const tbody = document.getElementById('admin-logs-tbody');
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading admin activity...</td></tr>';

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/audit-logs?page=${page}&limit=${limit}`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const logs = result.data.logs || [];
                        
                        if (logs.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No admin activity found.</td></tr>';
                            return;
                        }

                        tbody.innerHTML = logs.map(log => `
                            <tr>
                                <td>
                                    <div style="font-weight: 500;">${log.adminName || 'Unknown'}</div>
                                    <div style="font-size: 0.8rem; color: #666;">${log.adminEmail || 'N/A'}</div>
                                </td>
                                <td>
                                    <span class="status-badge status-active">${log.action}</span>
                                </td>
                                <td>${log.resourceType || 'N/A'}</td>
                                <td>
                                    <div style="font-size: 0.9rem;">
                                        ${log.details ? Object.entries(log.details).slice(0, 2).map(([k, v]) => `${k}: ${v}`).join('<br>') : 'N/A'}
                                    </div>
                                </td>
                                <td>${new Date(log.createdAt).toLocaleString()}</td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Failed to load admin logs</td></tr>';
                    }
                } catch (error) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading admin logs</td></tr>';
                }
            }

            async initializeSettings() {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.publicAdminUrl}/settings/initialize`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Default settings initialized successfully!');
                        this.loadSettings(this.currentSettingsCategory || 'general');
                    } else {
                        alert('Failed to initialize settings: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to initialize settings: ' + error.message);
                }
            }

            async exportAdminLogs() {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/audit-logs?export=true`);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `admin-logs-${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        alert('Admin logs exported successfully!');
                    } else {
                        alert('Failed to export admin logs');
                    }
                } catch (error) {
                    alert('Failed to export admin logs: ' + error.message);
                }
            }

            async clearOldLogs() {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/audit-logs/cleanup`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(`Cleared ${result.data.deletedCount || 0} old admin logs successfully!`);
                        this.loadAdminLogs();
                        this.loadSystemInfo();
                    } else {
                        alert('Failed to clear old logs: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to clear old logs: ' + error.message);
                }
            }

            async loadAnalytics() {
                if (!this.isConnected) return;

                try {
                    // Load order statistics for analytics
                    const response = await fetch(`${this.publicAdminUrl}/orders/stats?period=30d`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const stats = result.data.overview;
                        document.getElementById('analytics-revenue').textContent = `AED ${stats.totalRevenue?.toFixed(2) || '0.00'}`;
                        document.getElementById('analytics-orders').textContent = stats.totalOrders || 0;
                        document.getElementById('analytics-aov').textContent = `AED ${stats.averageOrderValue?.toFixed(2) || '0.00'}`;
                        
                        // Calculate growth (placeholder for now)
                        document.getElementById('analytics-growth').textContent = '+12%';
                    }
                } catch (error) {
                    console.error('Failed to load analytics:', error);
                }
            }

            openCoffeeModal(coffee = null) {
                const modal = document.getElementById('coffee-modal');
                const form = document.getElementById('coffee-form');
                const title = document.getElementById('modal-title');

                if (coffee) {
                    title.textContent = 'Edit Coffee';
                    // Populate form with coffee data
                } else {
                    title.textContent = 'Add Coffee';
                    form.reset();
                }

                // Load categories for the dropdown
                this.loadCategoriesForDropdown();

                modal.style.display = 'block';
            }

            async loadCategoriesForDropdown() {
                const categorySelect = document.getElementById('coffee-category');
                categorySelect.innerHTML = '<option value="">Loading categories...</option>';

                try {
                    const response = await fetch(`${this.apiBaseUrl}/categories`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        categorySelect.innerHTML = '<option value="">Select a category</option>';
                        result.data.forEach(category => {
                            if (category.isActive) {
                                const option = document.createElement('option');
                                option.value = category.name;
                                option.textContent = category.name;
                                categorySelect.appendChild(option);
                            }
                        });
                    } else {
                        categorySelect.innerHTML = '<option value="">Failed to load categories</option>';
                    }
                } catch (error) {
                    categorySelect.innerHTML = '<option value="">Error loading categories</option>';
                    console.error('Failed to load categories:', error);
                }
            }

            closeModal() {
                document.getElementById('coffee-modal').style.display = 'none';
            }

            async saveCoffee() {
                const form = document.getElementById('coffee-form');
                const formData = new FormData(form);

                // Validate file size (5MB limit)
                const fileInput = document.getElementById('coffee-image');
                if (fileInput.files[0]) {
                    const fileSize = fileInput.files[0].size / 1024 / 1024; // MB
                    if (fileSize > 5) {
                        alert('Image file size must be less than 5MB');
                        return;
                    }
                }

                // Create variants array for the three sizes
                const variants = [
                    {
                        size: '250g',
                        price: parseFloat(formData.get('price250g')) || 0,
                        stock: parseInt(formData.get('stock250g')) || 0
                    },
                    {
                        size: '500g',
                        price: parseFloat(formData.get('price500g')) || 0,
                        stock: parseInt(formData.get('stock500g')) || 0
                    },
                    {
                        size: '1kg',
                        price: parseFloat(formData.get('price1kg')) || 0,
                        stock: parseInt(formData.get('stock1kg')) || 0
                    }
                ];

                // Validate that at least one variant has a price > 0
                const validVariants = variants.filter(v => v.price > 0);
                if (validVariants.length === 0) {
                    alert('Please set at least one size with a valid price.');
                    return;
                }

                // Add variants to form data
                formData.append('variants', JSON.stringify(variants));

                // Set the main price to the 250g price for backward compatibility
                formData.append('price', variants[0].price.toString());

                // Calculate total stock from all variants
                const totalStock = variants.reduce((sum, variant) => sum + variant.stock, 0);
                formData.append('stock', totalStock.toString());

                // Handle category - convert to categories array
                const category = formData.get('category');
                if (category) {
                    formData.append('categories', JSON.stringify([category]));
                }
                formData.delete('category'); // Remove the old field

                // Remove the individual price/stock fields as they're now in variants
                ['price250g', 'price500g', 'price1kg', 'stock250g', 'stock500g', 'stock1kg'].forEach(field => {
                    formData.delete(field);
                });

                try {
                    // Show loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Saving...';
                    submitBtn.disabled = true;

                    const response = await fetch(`${this.apiBaseUrl}/coffees`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Coffee created successfully with multiple sizes!');
                        this.closeModal();
                        this.loadCoffees(); // Refresh the coffees list
                    } else {
                        alert('Failed to create coffee: ' + (result.message || 'Unknown error'));
                    }

                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;

                } catch (error) {
                    alert('Failed to save coffee: ' + error.message);

                    // Reset button state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Save Coffee';
                    submitBtn.disabled = false;
                }
            }

            async deleteCoffee(coffeeId) {
                if (!confirm('Are you sure you want to delete this coffee?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/coffees/${coffeeId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Coffee deleted successfully!');
                        this.loadCoffees(); // Refresh the list
                    } else {
                        alert('Failed to delete coffee: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to delete coffee: ' + error.message);
                }
            }

            // Category Management Methods
            async loadCategories() {
                if (!this.isConnected) return;

                const tbody = document.getElementById('categories-tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading categories...</td></tr>';

                try {
                    const response = await fetch(`${this.apiBaseUrl}/categories`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        if (result.data.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #7f8c8d;">
                                        No categories found. Click "Add Category" to create your first category.
                                    </td>
                                </tr>
                            `;
                        } else {
                            tbody.innerHTML = result.data.map(category => `
                                <tr>
                                    <td>${category.name}</td>
                                    <td>${category.description || 'N/A'}</td>
                                    <td><span style="background: ${category.color}; padding: 2px 8px; border-radius: 3px; color: white;">${category.color}</span></td>
                                    <td>0</td>
                                    <td>
                                        <span class="status-badge ${category.isActive ? 'status-active' : 'status-inactive'}">
                                            ${category.isActive ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn-danger" onclick="window.adminPanel.deleteCategory('${category._id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; color: #e74c3c;">
                                    Failed to load categories: ${result.message || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #e74c3c;">
                                Failed to load categories: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            openCategoryModal(category = null) {
                const modal = document.getElementById('category-modal');
                const form = document.getElementById('category-form');
                const title = document.getElementById('category-modal-title');

                if (category) {
                    title.textContent = 'Edit Category';
                    // Populate form with category data
                } else {
                    title.textContent = 'Add Category';
                    form.reset();
                }

                modal.style.display = 'block';
            }

            async saveCategory() {
                const form = document.getElementById('category-form');
                const formData = new FormData(form);

                try {
                    const response = await fetch(`${this.apiBaseUrl}/categories`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Category created successfully!');
                        this.closeModal('category-modal');
                        this.loadCategories(); // Refresh the categories list
                    } else {
                        alert('Failed to create category: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to save category: ' + error.message);
                }
            }

            async deleteCategory(categoryId) {
                if (!confirm('Are you sure you want to delete this category?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/categories/${categoryId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Category deleted successfully!');
                        this.loadCategories(); // Refresh the list
                    } else {
                        alert('Failed to delete category: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to delete category: ' + error.message);
                }
            }

            // Slider Management Methods
            async loadSliders() {
                if (!this.isConnected) return;

                const tbody = document.getElementById('sliders-tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading sliders...</td></tr>';

                try {
                    const response = await fetch(`${this.apiBaseUrl}/sliders`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        if (result.data.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #7f8c8d;">
                                        No sliders found. Click "Add Slider" to create your first slider.
                                    </td>
                                </tr>
                            `;
                        } else {
                            tbody.innerHTML = result.data.map(slider => `
                                <tr>
                                    <td><img src="${this.apiBaseUrl.replace('/api', '')}${slider.image}" alt="${slider.title}" style="width: 80px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                                    <td>${slider.title}</td>
                                    <td>
                                        <span class="status-badge ${slider.isActive ? 'status-active' : 'status-inactive'}">
                                            ${slider.isActive ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>${slider.viewCount || 0}</td>
                                    <td>${slider.clickCount || 0}</td>
                                    <td>
                                        <button class="btn-danger" onclick="window.adminPanel.deleteSlider('${slider._id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; color: #e74c3c;">
                                    Failed to load sliders: ${result.message || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #e74c3c;">
                                Failed to load sliders: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            openSliderModal(slider = null) {
                const modal = document.getElementById('slider-modal');
                const form = document.getElementById('slider-form');
                const title = document.getElementById('slider-modal-title');

                if (slider) {
                    title.textContent = 'Edit Slider';
                    // Populate form with slider data
                } else {
                    title.textContent = 'Add Slider';
                    form.reset();
                }

                modal.style.display = 'block';
            }

            async saveSlider() {
                const form = document.getElementById('slider-form');
                const formData = new FormData(form);

                try {
                    const response = await fetch(`${this.apiBaseUrl}/sliders`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Slider created successfully!');
                        this.closeModal('slider-modal');
                        this.loadSliders(); // Refresh the sliders list
                    } else {
                        alert('Failed to create slider: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to save slider: ' + error.message);
                }
            }

            async deleteSlider(sliderId) {
                if (!confirm('Are you sure you want to delete this slider?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/sliders/${sliderId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Slider deleted successfully!');
                        this.loadSliders(); // Refresh the list
                    } else {
                        alert('Failed to delete slider: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to delete slider: ' + error.message);
                }
            }

            // Notification Management Methods
            async loadNotifications(page = 1, applyFilters = false) {
                if (!this.isConnected) return;

                this.currentNotificationPage = page;
                const tbody = document.getElementById('notifications-tbody');
                tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading notifications...</td></tr>';

                try {
                    // Build query parameters
                    const params = new URLSearchParams({
                        page: page,
                        limit: 20
                    });

                    // Add filters if applying
                    if (applyFilters) {
                        const statusFilter = document.getElementById('notification-status-filter').value;
                        const typeFilter = document.getElementById('notification-type-filter').value;
                        const searchQuery = document.getElementById('notification-search').value;

                        if (statusFilter) params.append('status', statusFilter);
                        if (typeFilter) params.append('type', typeFilter);
                        if (searchQuery) params.append('search', searchQuery);
                    }

                    const response = await fetch(`${this.apiBaseUrl}/notifications?${params}`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        if (result.data.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="9" style="text-align: center; color: #7f8c8d;">
                                        No notifications found. ${applyFilters ? 'Try adjusting your filters or' : ''} Click "Create Notification" to send your first notification.
                                    </td>
                                </tr>
                            `;
                        } else {
                            tbody.innerHTML = result.data.map(notification => `
                                <tr>
                                    <td><strong>${notification.title}</strong></td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${notification.message}">${notification.message}</td>
                                    <td><span class="status-badge status-${notification.type}">${notification.type}</span></td>
                                    <td>
                                        <span class="status-badge ${this.getNotificationStatusClass(notification.status)}">
                                            ${notification.status}
                                        </span>
                                    </td>
                                    <td>${this.formatTargetAudience(notification.targetAudience)}</td>
                                    <td>${notification.scheduledDate ? new Date(notification.scheduledDate).toLocaleString() : 'N/A'}</td>
                                    <td>${notification.sentDate ? new Date(notification.sentDate).toLocaleString() : 'N/A'}</td>
                                    <td>${this.formatDeliveryStats(notification.deliveryStats)}</td>
                                    <td style="white-space: nowrap;">
                                        ${notification.status === 'draft' || notification.status === 'scheduled' ? `<button class="btn-primary btn-sm" onclick="window.adminPanel.sendNotification('${notification._id}')">Send</button>` : ''}
                                        <button class="btn-secondary btn-sm" onclick="window.adminPanel.editNotification('${notification._id}')">Edit</button>
                                        ${notification.status !== 'sent' ? `<button class="btn-danger btn-sm" onclick="window.adminPanel.deleteNotification('${notification._id}')">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('');
                        }

                        // Update pagination
                        this.updateNotificationPagination(result.pagination);
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" style="text-align: center; color: #e74c3c;">
                                    Failed to load notifications: ${result.message || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; color: #e74c3c;">
                                Failed to load notifications: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            openNotificationModal(notification = null) {
                const modal = document.getElementById('notification-modal');
                const form = document.getElementById('notification-form');
                const title = document.getElementById('notification-modal-title');

                if (notification) {
                    title.textContent = 'Edit Notification';
                    // Populate form with notification data
                } else {
                    title.textContent = 'Create Notification';
                    form.reset();
                }

                modal.style.display = 'block';
            }

            async saveNotification() {
                const form = document.getElementById('notification-form');
                const formData = new FormData(form);

                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Notification created successfully!');
                        this.closeModal('notification-modal');
                        this.loadNotifications(); // Refresh the notifications list
                    } else {
                        alert('Failed to create notification: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to save notification: ' + error.message);
                }
            }

            async sendNotification(notificationId) {
                if (!confirm('Are you sure you want to send this notification now?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications/${notificationId}/send`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Notification sent successfully!');
                        this.loadNotifications(); // Refresh the list
                    } else {
                        alert('Failed to send notification: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to send notification: ' + error.message);
                }
            }

            async deleteNotification(notificationId) {
                if (!confirm('Are you sure you want to delete this notification?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications/${notificationId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Notification deleted successfully!');
                        this.loadNotifications(this.currentNotificationPage); // Refresh the current page
                        this.loadNotificationStats(); // Refresh stats
                    } else {
                        alert('Failed to delete notification: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to delete notification: ' + error.message);
                }
            }

            // Enhanced notification helper methods
            getNotificationStatusClass(status) {
                switch (status) {
                    case 'sent': return 'status-completed';
                    case 'scheduled': return 'status-pending';
                    case 'sending': return 'status-warning';
                    case 'failed': return 'status-error';
                    default: return 'status-inactive';
                }
            }

            formatTargetAudience(targetAudience) {
                if (!targetAudience || targetAudience.length === 0) return 'All';
                return targetAudience.join(', ').replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            formatDeliveryStats(stats) {
                if (!stats || stats.totalSent === 0) return 'N/A';
                const deliveryRate = Math.round((stats.totalDelivered / stats.totalSent) * 100);
                return `${stats.totalSent} sent, ${stats.totalDelivered} delivered (${deliveryRate}%)`;
            }

            updateNotificationPagination(pagination) {
                if (!pagination) return;

                const pageInfo = document.getElementById('notification-page-info');
                const prevBtn = document.getElementById('notification-prev-page');
                const nextBtn = document.getElementById('notification-next-page');

                if (pageInfo) pageInfo.textContent = `Page ${pagination.page} of ${pagination.pages}`;
                if (prevBtn) prevBtn.disabled = pagination.page <= 1;
                if (nextBtn) nextBtn.disabled = pagination.page >= pagination.pages;
            }

            clearNotificationFilters() {
                document.getElementById('notification-status-filter').value = '';
                document.getElementById('notification-type-filter').value = '';
                document.getElementById('notification-search').value = '';
                this.loadNotifications(1);
            }

            async loadNotificationStats() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications/stats`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const stats = result.data.overview;
                        document.getElementById('total-notifications').textContent = stats.totalNotifications || 0;
                        document.getElementById('sent-notifications').textContent = stats.sentNotifications || 0;
                        document.getElementById('scheduled-notifications').textContent = stats.scheduledNotifications || 0;
                        
                        const deliveryRate = stats.totalSent > 0 ? Math.round((stats.totalDelivered / stats.totalSent) * 100) : 0;
                        document.getElementById('delivery-rate').textContent = `${deliveryRate}%`;
                    }
                } catch (error) {
                    console.error('Failed to load notification stats:', error);
                }
            }

            openTestNotificationModal() {
                const modal = document.getElementById('test-notification-modal');
                const form = document.getElementById('test-notification-form');
                form.reset();
                this.toggleTestTargetFields('all');
                modal.style.display = 'block';
            }

            toggleTestTargetFields(target) {
                const topicGroup = document.getElementById('test-topic-group');
                const devicesGroup = document.getElementById('test-devices-group');

                topicGroup.style.display = target === 'topic' ? 'block' : 'none';
                devicesGroup.style.display = target === 'devices' ? 'block' : 'none';
            }

            async sendTestNotification() {
                const form = document.getElementById('test-notification-form');
                const formData = new FormData(form);

                const testData = {
                    title: formData.get('title'),
                    message: formData.get('message'),
                    target: formData.get('target')
                };

                if (testData.target === 'topic') {
                    testData.topic = formData.get('topic');
                } else if (testData.target === 'devices') {
                    const deviceTokens = formData.get('deviceTokens').split(',').map(token => token.trim()).filter(token => token);
                    testData.deviceTokens = deviceTokens;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications/test`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(`Test notification sent successfully!\n\nResult: ${result.message}\nSent: ${result.sendResult?.totalSent || 0}\nDelivered: ${result.sendResult?.successCount || 0}`);
                        this.closeModal('test-notification-modal');
                    } else {
                        alert('Failed to send test notification: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to send test notification: ' + error.message);
                }
            }

            async showNotificationStats() {
                const modal = document.getElementById('notification-stats-modal');
                const content = document.getElementById('notification-stats-content');
                
                content.innerHTML = '<div class="loading">Loading detailed statistics...</div>';
                modal.style.display = 'block';

                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications/stats`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const { overview, recentNotifications, typeStats } = result.data;
                        
                        content.innerHTML = `
                            <div class="stats-overview">
                                <h3>Overview</h3>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <strong>${overview.totalNotifications}</strong>
                                        <span>Total Notifications</span>
                                    </div>
                                    <div class="stat-item">
                                        <strong>${overview.sentNotifications}</strong>
                                        <span>Sent</span>
                                    </div>
                                    <div class="stat-item">
                                        <strong>${overview.scheduledNotifications}</strong>
                                        <span>Scheduled</span>
                                    </div>
                                    <div class="stat-item">
                                        <strong>${overview.totalSent}</strong>
                                        <span>Total Messages Sent</span>
                                    </div>
                                    <div class="stat-item">
                                        <strong>${overview.totalDelivered}</strong>
                                        <span>Total Delivered</span>
                                    </div>
                                    <div class="stat-item">
                                        <strong>${overview.totalClicked}</strong>
                                        <span>Total Clicked</span>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-section">
                                <h3>By Type</h3>
                                <div class="type-stats">
                                    ${typeStats.map(type => `
                                        <div class="type-stat">
                                            <strong>${type._id}</strong>: ${type.count} notifications 
                                            (${type.totalSent} sent, ${type.totalClicked} clicked)
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="stats-section">
                                <h3>Recent Notifications</h3>
                                <div class="recent-notifications">
                                    ${recentNotifications.map(notif => `
                                        <div class="recent-notification">
                                            <strong>${notif.title}</strong> (${notif.type})
                                            <br><small>Sent: ${new Date(notif.sentDate).toLocaleString()}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<div class="error">Failed to load statistics</div>';
                    }
                } catch (error) {
                    content.innerHTML = '<div class="error">Failed to load statistics: ' + error.message + '</div>';
                }
            }

            async editNotification(notificationId) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/notifications/${notificationId}`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        this.openNotificationModal(result.data);
                    } else {
                        alert('Failed to load notification: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to load notification: ' + error.message);
                }
            }

            closeModal(modalId = null) {
                if (modalId) {
                    document.getElementById(modalId).style.display = 'none';
                } else {
                    // Close all modals
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            }

            // User Management Functions
            searchUsers() {
                this.loadUsers(1); // Reset to first page when searching
            }

            clearUserFilters() {
                document.getElementById('user-search').value = '';
                document.getElementById('user-role-filter').value = '';
                document.getElementById('user-status-filter').value = '';
                this.loadUsers(1);
            }

            async exportUsers() {
                if (!this.isConnected) return;

                try {
                    // Build query parameters for export
                    const params = new URLSearchParams();
                    
                    const searchValue = document.getElementById('user-search')?.value;
                    const roleFilter = document.getElementById('user-role-filter')?.value;
                    const statusFilter = document.getElementById('user-status-filter')?.value;

                    if (searchValue) params.append('search', searchValue);
                    if (roleFilter) params.append('role', roleFilter);
                    if (statusFilter) params.append('status', statusFilter);

                    const response = await fetch(`${this.apiBaseUrl}/admin/users/export?${params}`);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        alert('Users exported successfully!');
                    } else {
                        alert('Failed to export users');
                    }
                } catch (error) {
                    alert('Failed to export users: ' + error.message);
                }
            }

            async editUser(userId) {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/users/${userId}`);
                    const result = await response.json();

                    if (response.ok && result.success) {
                        const user = result.data || result.user;
                        
                        // Populate form
                        document.getElementById('user-id').value = user._id || user.id;
                        document.getElementById('user-name').value = user.name || '';
                        document.getElementById('user-email').value = user.email || '';
                        document.getElementById('user-phone').value = user.phone || '';
                        document.getElementById('user-active').checked = user.isActive;

                        // Handle roles
                        document.getElementById('role-customer').checked = false;
                        document.getElementById('role-admin').checked = false;
                        
                        if (Array.isArray(user.roles)) {
                            user.roles.forEach(role => {
                                const checkbox = document.getElementById(`role-${role}`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }

                        // Show modal
                        document.getElementById('user-modal').style.display = 'block';
                    } else {
                        alert('Failed to load user: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to load user: ' + error.message);
                }
            }

            async saveUser() {
                const form = document.getElementById('user-form');
                const formData = new FormData(form);
                const userId = formData.get('id');

                // Collect roles
                const roles = [];
                if (document.getElementById('role-customer').checked) roles.push('customer');
                if (document.getElementById('role-admin').checked) roles.push('admin');

                if (roles.length === 0) {
                    alert('Please select at least one role for the user.');
                    return;
                }

                const userData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone') || null,
                    roles: roles,
                    isActive: document.getElementById('user-active').checked
                };

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('User updated successfully!');
                        this.closeModal('user-modal');
                        this.loadUsers(this.currentUserPage || 1);
                        this.loadUserStats();
                    } else {
                        alert('Failed to update user: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to update user: ' + error.message);
                }
            }

            async toggleUserStatus(userId, newStatus) {
                if (!this.isConnected) return;

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/users/${userId}/toggle-status`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isActive: newStatus })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                        this.loadUsers(this.currentUserPage || 1);
                        this.loadUserStats();
                    } else {
                        alert('Failed to update user status: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to update user status: ' + error.message);
                }
            }

            confirmDeleteUser(userId, userName, userEmail) {
                this.userToDelete = userId;
                
                document.getElementById('user-delete-info').innerHTML = `
                    <div style="font-weight: 500;">${userName}</div>
                    <div style="color: #666; font-size: 0.9rem;">${userEmail}</div>
                `;
                
                document.getElementById('user-delete-modal').style.display = 'block';
            }

            async deleteUser() {
                if (!this.userToDelete || !this.isConnected) return;

                try {
                    const response = await fetch(`${this.apiBaseUrl}/admin/users/${this.userToDelete}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('User deleted successfully!');
                        this.closeModal('user-delete-modal');
                        this.loadUsers(this.currentUserPage || 1);
                        this.loadUserStats();
                        this.userToDelete = null;
                    } else {
                        alert('Failed to delete user: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Failed to delete user: ' + error.message);
                }
            }
        }

        // Initialize admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.adminPanel = new WebAdminPanel();
        });

        // Logout function
        function logout() {
            localStorage.removeItem('adminLoggedIn');
            location.reload();
        }
    </script>
</body>
</html>
